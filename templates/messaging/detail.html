{% extends 'market/base.html' %}
{% load static %}
{% load crispy_forms_tags %}


{% block title %}
Messages with {{ other_user.username }}
{% endblock title %}

{% block main %}

<style>
    .msg-sent {float: right; background-color: green; }
    .msg-received {float: left; background-color: blue; }
</style>

<main class="grow" style="margin: 2%;">

    <div class="w-full px-5 mx-auto"> <!-- w-full px-5 mx-auto -->
        <div class="lg:flex">




            <main id="content-wrapper" class="flex-auto w-full min-w-0 lg:static lg:max-h-full lg:overflow-visible">
                <div class="flex w-full">

                    <div class="flex-auto min-w-0 pt-6 lg:px-8 lg:pt-8 pb:12 xl:pb-24 lg:pb-16">
                
                        <div class="text-center pb-4 mb-8 border-b border-gray-200 dark:border-gray-800 pl-15vw pr-15vw">

                    
                            <h1 class="mb-4 text-3xl font-extrabold text-gray-900 dark:text-white md:text-5xl lg:text-6xl"><span class="text-transparent bg-clip-text bg-gradient-to-r to-emerald-600 from-sky-400">{{ item.title|safe }}</span></h1>
                            {% comment %} <p class="text-lg font-normal text-gray-500 lg:text-xl dark:text-gray-400">{{ item.description|safe }}</p> {% endcomment %}
                            
                            

                            





                        </div>
                
                         <div id="mainContent" class="pl-15vw pr-15vw">

                            <div style="display: inline-grid;" id="messages-container">
                                {% for msg in all_messages_between_these_two_users %}
                                    {% if msg.sender_of_message == request.user %}
                                        <p class="msg-sent">{{ msg.body }}</p>
                                    {% else %}
                                        <p class="msg-received">{{ msg.body }}</p>
                                    {% endif %}
                                {% endfor %}
                                <div class="py-1"></div>
                            </div>

                            <div class="py-2"></div>



                            
                            <div class="mt-6 w-full bg-white rounded-lg border shadow-md dark:bg-gray-800 dark:border-gray-700">

                                <form action="" id="message-form" method="POST">
                                    {% csrf_token %}
                                    {{ form|crispy }}
                                    <button type="submit" id="message-send">Send</button>
                                </form>

                            </div>
                            

                    
                        </div> 

                    </div>


                

                </div> 
                
            </main> 


        </div>
    </div>


    



</main>

{% endblock main %}

{% block JavaScript %}
<script>

    let form = document.getElementById("message-form");
    form.addEventListener("submit", sendMessage);

    function sendMessage(e) {
        e.preventDefault(); // Prevents page from reloading
        let message = document.getElementById("id_body").value;
        console.log(message);
        // Use Fetch API to send message
        const data = {
            message: message,
        };
        let url = `{% url 'sent_direct_message' other_user.id %}`;
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data),
        }).then(
            response => response.json()
        ).then(data => {
            console.log(data);
            let msg_div = document.createElement('div');
            msg_div.classList.add('msg-sent');
            msg_div.innerText = message;
            let messages_container = document.getElementById("messages-container");
            messages_container.appendChild(msg_div);
            document.getElementById("id_body").value = "";
        }).catch((error) => {
            console.error('Error: ' + error)
        });

    }

    interval_in_seconds = 1;
    setInterval(receiveMessages, interval_in_seconds * 1000); // Run receiveMessages() to get the data every 3 seconds.

    let counter = {{ num_messages_from_other_user_to_current_user }};

    function receiveMessages() {
        let url = `{% url 'received_direct_messages' other_user.id %}`;
        fetch(url).then(
            response => response.json()
        ).then(data => {
            console.log(data);
            // If counter is the same as the data length, then there are no new messages (because the length of the array of messages we're passing in is zero).
            if (data.length == 0) {
                // Do nothing
            } else {
                let numberOfNewMessages = data.length - counter;
                newMessages = data.slice(data.length - numberOfNewMessages, data.length); // All the new messages 
                if (counter == data.length) { 
                    console.log("There are no new messages.") 
                } else {
                    messages_container = document.getElementById("messages-container");
                    for (newMessage of newMessages) {
                        msg_div = document.createElement('div');
                        msg_div.classList.add('msg-received');
                        msg_div.innerText = newMessage;
                        messages_container.appendChild(msg_div);
                    }
                    document.getElementById("id_body").value = "";
                }
            }
            counter = data.length;
        }).catch((error) => {
            console.error('Error: ' + error)
        });
    }

</script>
{% endblock JavaScript %}





